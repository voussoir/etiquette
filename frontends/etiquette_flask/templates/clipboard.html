<!DOCTYPE html5>
<html>
<head>
    {% import "header.html" as header %}
    {% import "clipboard_tray.html" as clipboard_tray %}
    <title>Clipboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/static/common.css">
    <script src="/static/common.js"></script>
    <script src="/static/js/photoclipboard.js"></script>

<style>
body
{
    display: grid;
    grid-template-rows: auto 1fr;
    grid-template-columns: 1fr 300px;
    grid-template-areas:
        "header header"
        "left right";
}
#header
{
    grid-area: header;
}
#left
{
    word-break: break-word;
    grid-area: left;
}
#right
{
    position: fixed;
    right: 8px;
    bottom: 8px;
    top: 30px;
    width: 300px;
    grid-area: right;

    display: grid;
    grid-template-rows: 1fr 1fr 1fr;
    grid-template-areas:
        "add_tag_area"
        "remove_tag_area"
        "message_area";

    background-color: rgba(0, 0, 0, 0.1);
}
#add_tag_area
{
    grid-area: add_tag_area;
    margin: auto;
}
#remove_tag_area
{
    grid-area: remove_tag_area;
    margin: auto;
}
#message_area
{
    grid-area: message_area;
    margin: 8px;
}
</style>
</head>


<body>
{{header.make_header(session=session)}}
<div id="left">
    <span>The clipboard contains <span class="clipboard_count">0</span> items</span>
    <div id="photo_card_holder">
    </div>
</div>
<div id="right">
    <div id="add_tag_area">
        <input type="text" id="add_tag_textbox">
        <button class="add_tag_button green_button" id="add_tag_button" onclick="submit_add_tag(add_remove_callback);">add</button>
    </div>
    <div id="remove_tag_area">
        <input type="text" id="remove_tag_textbox">
        <button class="red_button" id="remove_tag_button" onclick="submit_remove_tag(add_remove_callback);">Remove</button>
    </div>
    <div id="message_area">
    </div>
</div>
</body>


<script type="text/javascript">
var divs = {};
var needed = new Set();
var holder = document.getElementById("photo_card_holder");

var add_box = document.getElementById("add_tag_textbox");
var add_button = document.getElementById("add_tag_button");
add_box.onkeydown = function(){entry_with_history_hook(add_box, add_button)};
var remove_box = document.getElementById("remove_tag_textbox");
var remove_button = document.getElementById("remove_tag_button");
remove_box.onkeydown = function(){entry_with_history_hook(remove_box, remove_button)};

function recalculate_needed()
{
    needed = new Set();
    photo_clipboard.forEach(function(photo_id)
    {
        if (!(photo_id in divs))
        {
            needed.add(photo_id);
        }
    });
}

function refresh_divs()
{
    for (var photo_id in divs)
    {
        var photo_div = divs[photo_id];
        var should_keep = photo_clipboard.has(photo_id);
        var on_page = holder.contains(photo_div);
        if (on_page && !should_keep)
        {
            holder.removeChild(photo_div)
        }
        if (!on_page && should_keep)
        {
            holder.appendChild(photo_div)
        }
    }
}

function request_more_divs()
{
    if (needed.size == 0)
    {
        return;
    }
    var url = "/batch/photos/photo_card";
    var data = new FormData();
    var photo_ids = Array.from(needed).join(",");
    data.append("photo_ids", photo_ids);
    function callback(response)
    {
        if (response["meta"]["status"] !== 200)
        {
            return;
        }
        response = response["data"];
        var holder = document.getElementById("photo_card_holder");
        for (photo_id in response)
        {
            photo_div = html_to_element(response[photo_id]);
            divs[photo_id] = photo_div;
            needed.delete(photo_id)
            holder.appendChild(photo_div);
        }
        apply_check_all();
    }
    post(url, data, callback);
}

function myhook()
{
    recalculate_needed();
    request_more_divs();
    refresh_divs();
}

on_clipboard_load_hooks.push(myhook);
on_clipboard_save_hooks.push(myhook);


function submit_add_tag(callback)
{
    var box = document.getElementById("add_tag_textbox");
    var tagname = box.value.trim();
    if (! tagname)
        {return}

    box.value = "";
    return submit_add_remove_tag("add", tagname, callback);
}
function submit_remove_tag(callback)
{
    var box = document.getElementById("remove_tag_textbox");
    var tagname = box.value.trim();
    if (! tagname)
        {return}

    box.value = "";
    return submit_add_remove_tag("remove", tagname, callback);
}
function submit_add_remove_tag(action, tagname, callback)
{
    var url = "/batch/photos/" + action + "_tag";
    var data = new FormData();
    var photo_ids = Array.from(photo_clipboard).join(",");
    data.append("photo_ids", photo_ids);
    data.append("tagname", tagname);
    post(url, data, callback);
}
function add_remove_callback(response)
{
    response = response["data"];
    var tagname = response["tagname"];
    var message_positivity;
    var message_text;

    if ("error_type" in response)
    {
        message_positivity = "message_negative";
        message_text = response["error_message"];
    }
    else if ("action" in response)
    {
        var action = response["action"];
        message_positivity = "message_positive";
        if (action == "add")
        {message_text = "Added tag " + tagname;}

        else if (action == "remove")
        {message_text = "Removed tag " + tagname;}
    }
    create_message_bubble(message_area, message_positivity, message_text, 8000);
}
</script>
</html>
